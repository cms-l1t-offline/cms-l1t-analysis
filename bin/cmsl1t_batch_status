#!/usr/bin/env python
import click
import click_log
import glob
import logging
import pandas as pd
import re
import os
import sys
from tabulate import tabulate
import shutil

from cmsl1t.batch import Batch, Status, condor_status, lsf_status

if sys.version_info[0] < 3:
    from StringIO import StringIO
else:
    from io import StringIO

logger = logging.getLogger(__name__)
click_log.basic_config(logger)


def update_job_status(row):
    job = row.local_id
    batch = row.batch
    batch_id = row.batch_id
    job_path = row.output_folder
    job_status = row.status
    if job_status == Status.FINISHED:
        return job_status
    else:
        # check if output files exist
        if has_output_files(job_path):
            return 'FINISHED'

        batch_status = get_batch_status(batch, batch_id)
        if batch_status:
            return batch_status
        else:
            return Status.FAILED


def has_output_files(job_path):
    path = os.path.join(job_path, 'plots-v1', '*.root')
    output_files = glob.glob(path)
    return output_files


def get_batch_status(batch, batch_id):
    if batch == Batch.lsf:
        return lsf_status(batch_id)
    elif batch == Batch.condor:
        return condor_status(batch_id)
    logging.error('Unknown batch system "{0}"'.format(batch))
    return Status.UNKNOWN


@click.command()
@click.option(
    '-i', '--info_file', help='path to info.csv', type=click.Path(exists=True),
    required=True,
)
@click_log.simple_verbosity_option(logger)
def run(info_file):
    df = pd.read_csv(info_file)

    df['status'] = df.apply(update_job_status, axis=1)

    print(tabulate(df[['local_id', 'status', 'output_folder']],
                   headers='keys', tablefmt='psql', showindex=False))
    # make backup file
    shutil.copy(info_file, info_file + '.bak')
    # update status file
    df.to_csv(info_file)

if __name__ == '__main__':
    run()
